#!/bin/bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

OPTIONAL_SCRIPTS=(brew ente keyd proton vscode 1password-cli kde-restore dotfiles)

echo "Select optional scripts to run after setup:"
SELECTED=()
for script in "${OPTIONAL_SCRIPTS[@]}"; do
  read -rp "  Run $script? [Y/n] " answer
  if [[ "${answer,,}" != "n" ]]; then
    SELECTED+=("$script")
  fi
done
echo ""

# --- 1. SYSTEM UPDATE & RPM FUSION ---
sudo dnf upgrade -y

# Enable RPM Fusion (Essential for Steam, NVidia/AMD drivers, and codecs)
sudo dnf install -y \
  https://download1.rpmfusion.org/free/fedora/rpmfusion-free-release-$(rpm -E %fedora).noarch.rpm \
  https://download1.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-$(rpm -E %fedora).noarch.rpm

# --- 2. FLATPAK SETUP ---
# Enable Flathub (must be before any flatpak installs)
sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo

# --- 3. GAMING STACK & HARDWARE DRIVERS ---

# Install AMD 32-bit libs for Proton, plus launchers and tools
sudo dnf install -y \
  vulkan-loader.i686 mesa-vulkan-drivers.i686 mesa-libGL.i686 \
  lutris gamemode mangohud

# Steam: Flatpak for sandboxing
flatpak install -y flathub com.valvesoftware.Steam

# Bottles: Windows app compatibility layer
flatpak install -y flathub com.usebottles.bottles

# Solaar for Logitech MX Keys/Master
sudo dnf install -y solaar

# OpenRazer for your DeathAdder
# Adds the OpenSUSE build repo for Fedora
sudo dnf config-manager --add-repo https://download.opensuse.org/repositories/hardware:razer/Fedora_$(rpm -E %fedora)/hardware:razer.repo
sudo dnf install -y openrazer-meta openrazer-driver-dkms

# Add user to plugdev for Razer daemon access (Requires reboot)
sudo usermod -aG plugdev $USER

# --- 4. PRODUCTIVITY APPS ---
# Discord: Official build wrapped in Flatpak
flatpak install -y flathub com.discordapp.Discord

# Slack: Official client
flatpak install -y flathub com.slack.Slack

# Obsidian: Verified by devs
flatpak install -y flathub md.obsidian.Obsidian

# Todoist: Task management
flatpak install -y flathub com.todoist.Todoist

# Calibre: E-book management
flatpak install -y flathub com.calibre_ebook.calibre

# Signal: Encrypted messaging
flatpak install -y flathub org.signal.Signal

# 1Password: Password manager
flatpak install -y flathub com.onepassword.OnePassword

# vim
sudo dnf install -y vim

# homebrew pre-req
sudo dnf group install -y development-tools

# claude
curl -fsSL https://claude.ai/install.sh | bash

# --- RUN SELECTED OPTIONAL SCRIPTS ---
REPO_DIR="$(dirname "$SCRIPT_DIR")"
for script in "${SELECTED[@]}"; do
  echo "Running $script..."
  case "$script" in
    kde-restore) bash "$REPO_DIR/kde/kde-panel" restore ;;
    dotfiles)    bash "$REPO_DIR/setup" ;;
    *)           bash "$SCRIPT_DIR/$script" ;;
  esac
done
