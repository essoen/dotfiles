#!/bin/bash

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

OPTIONAL_SCRIPTS=(brew ente keyd proton)

echo "Select optional scripts to run after setup:"
SELECTED=()
for script in "${OPTIONAL_SCRIPTS[@]}"; do
  read -rp "  Run $script? [Y/n] " answer
  if [[ "${answer,,}" != "n" ]]; then
    SELECTED+=("$script")
  fi
done
echo ""

# --- 1. SYSTEM UPDATE & RPM FUSION ---
sudo dnf upgrade -y

# Enable RPM Fusion (Essential for Steam, NVidia/AMD drivers, and codecs)
sudo dnf install -y \
  https://download1.rpmfusion.org/free/fedora/rpmfusion-free-release-$(rpm -E %fedora).noarch.rpm \
  https://download1.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-$(rpm -E %fedora).noarch.rpm

# --- 2. GAMING STACK & HARDWARE DRIVERS ---

# Install AMD 32-bit libs for Proton, plus launchers and tools
sudo dnf install -y \
  vulkan-loader.i686 mesa-vulkan-drivers.i686 mesa-libGL.i686 \
  lutris gamemode mangohud

# Steam: Flatpak for sandboxing
flatpak install -y flathub com.valvesoftware.Steam

# Bottles: Windows app compatibility layer
flatpak install -y flathub com.usebottles.bottles

# Solaar for Logitech MX Keys/Master
sudo dnf install -y solaar

# OpenRazer for your DeathAdder
# Adds the OpenSUSE build repo for Fedora
sudo dnf config-manager --add-repo https://download.opensuse.org/repositories/hardware:razer/Fedora_$(rpm -E %fedora)/hardware:razer.repo
sudo dnf install -y openrazer-meta openrazer-driver-dkms

# Add user to plugdev for Razer daemon access (Requires reboot)
sudo usermod -aG plugdev $USER

# --- 3. FLATPAK SETUP ---
# Enable Flathub (Central App Store)
sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo

# --- 4. PRODUCTIVITY APPS ---
# Discord: Official build wrapped in Flatpak
flatpak install -y flathub com.discordapp.Discord

# Slack: Official client
flatpak install -y flathub com.slack.Slack

# Obsidian: Verified by devs
flatpak install -y flathub md.obsidian.Obsidian

# Todoist: Task management
flatpak install -y flathub com.todoist.Todoist

# VS Code: Stable, integrates with system
flatpak install -y flathub com.visualstudio.code

# Calibre: E-book management (Flathub offers latest updates faster than default repos)【8】【9】
flatpak install -y flathub com.calibre_ebook.calibre

# Signal: Encrypted messaging
flatpak install -y flathub org.signal.Signal

# 1Password: Password manager
flatpak install -y flathub com.onepassword.OnePassword

# vim
sudo dnf install -y vim

# homebrew pre-req
sudo dnf group install development-tools
sudo dnf install procps-ng curl file

# claude
curl -fsSL https://claude.ai/install.sh | bash

# --- RUN SELECTED OPTIONAL SCRIPTS ---
for script in "${SELECTED[@]}"; do
  echo "Running $script..."
  bash "$SCRIPT_DIR/$script"
done

# --- RESTORE KDE PANEL CONFIG ---
read -rp "Restore KDE panel config? [Y/n] " answer
if [[ "${answer,,}" != "n" ]]; then
  bash "$(dirname "$SCRIPT_DIR")/kde/kde-panel" restore
fi

# --- SYMLINK DOTFILES ---
read -rp "Run dotfiles setup (symlink bash, git, ssh configs)? [Y/n] " answer
if [[ "${answer,,}" != "n" ]]; then
  bash "$(dirname "$SCRIPT_DIR")/setup.sh"
fi
